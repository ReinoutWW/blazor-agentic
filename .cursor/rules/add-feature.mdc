---
description: 
globs: 
alwaysApply: true
---
# HealthVoiceÂ â€“ Newâ€¯Featureâ€¯AdditionÂ Playbook

> **Purpose**Â Â A repeatable, endâ€‘toâ€‘end checklist that guarantees every new feature respects HealthVoiceâ€™s layered architecture, cleanâ€‘code style, and continuousâ€‘delivery constraints.

---

## 0Â Â Preparation & Ticket Grooming

| ğŸ”Â Task                     | Detail                                                                                                 |
| --------------------------- | ------------------------------------------------------------------------------------------------------ |
| **0.1 Clarify requirement** | Capture user story, acceptance criteria, UX mockâ€‘ups, and nonâ€‘functional needs (perf, security, GDPR). |
| **0.2 Impact scan**         | Identify affected domain concepts, services, repositories, UI pages, external APIs.                    |
| **0.3 Size & slice**        | Split into vertical slices (thin walking skeletons) that cross all four layers.                        |
| **0.4 Create git branch**   | `feature/<jiraâ€‘id>-<conciseâ€‘name>`; keep PRs â‰¤Â 400Â LOC.                                                |

---

## 1Â Â Stepâ€‘byâ€‘Step Flow (OneÂ VerticalÂ Slice)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Domain      â”‚ --> â”‚  Business    â”‚ --> â”‚ Infrastructureâ”‚ --> â”‚    UI      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                   â–²                     â–²                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       Automated & Manual Tests
```

| #                                               | Layer                                             | What to do                                                                                                              | Crossâ€‘checks                                                |
| ----------------------------------------------- | ------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| **1**                                           | **Domain**                                        | *Define / update* entity, value object, enum, or domain event. Prefer immutable `record`.                               | **No EF** or UI types. Naming follows Â§2 of style guide.    |
| **2**                                           | **Business**                                      | *Add* command/query DTO, service method, validation (FluentValidation), unit tests.                                     | No `AppDbContext`, no `HttpContext`. Use constructor DI.    |
| **3a**                                          | **Infrastructure â€“ Model**                        | Extend `AppDbContext` with `DbSet<TEntity>` (internal).                                                                 | ğŸ›‘Â Never expose context outside repo.                       |
| **3b**                                          | **Infrastructure â€“ Repos**                        | Implement new `IRepository<TEntity>` or query spec.                                                                     | No LINQ leaking (`IQueryable`). All reads `AsNoTracking()`. |
| **3c**                                          | **Migrations**                                    | `dotnet ef migrations add <Feature>` executed from **Infrastructure** project. Verify SQL for both SQLite & SQLÂ Server. | Migration script reviewed in PR.                            |
| **4**                                           | **Businessâ€‘Infra Glue**                           | Ensure `EfUnitOfWork` exposes repo via `Repo<TEntity>()`.                                                               | Update DI tests.                                            |
| **5**                                           | **UI (Blazor)**                                   | Create/modify Razor page/component. Bind to Business service via `@inject`. **No logic** beyond data shaping.           | Follow UI rules (async lifeâ€‘cycle, minimal cascading).      |
| **6**                                           | **DI Registration**                               | Add to `HealthVoice.Blazor/Program.cs` if a new concrete service or options class is introduced.                        | Keep scopes aligned (`Scoped` by default).                  |
| **7**                                           | **Tests**                                         |                                                                                                                         |                                                             |
| *Domain*: new invariants.                       |                                                   |                                                                                                                         |                                                             |
| *Business*: service happyâ€‘/sadâ€‘path.            |                                                   |                                                                                                                         |                                                             |
| *Infra*: migration smokeâ€‘test on SQLite inâ€‘mem. |                                                   |                                                                                                                         |                                                             |
| *UI*: bUnit render + interaction.               | 100â€¯% branch coverage on new code (use Coverlet). |                                                                                                                         |                                                             |
| **8**                                           | **Docs & Changelog**                              | Update `CHANGELOG.md` and, if public, API reference in `docs/`.                                                         | Include migration note if DB change.                        |
| **9**                                           | **Static analysis**                               | `dotnet format`, `dotnet build -warnaserror`, analyzers.                                                                | Pipeline must stay green locally.                           |
| **10**                                          | **Commit & PR**                                   | Push branch, open PR with template checklist, seek two approvals.                                                       | CI must pass before merge.                                  |
| **11**                                          | **Deploy to Dev**                                 | Feature flag if risky; run smoke tests.                                                                                 | Rollback plan documented.                                   |

---

## 2Â Â Interaction Contract Matrix

| Trigger            | Business Service                 | Repository Call(s)                                                                     | DB / External API                          | UI Event                                                      |
| ------------------ | -------------------------------- | -------------------------------------------------------------------------------------- | ------------------------------------------ | ------------------------------------------------------------- |
| User clicks *Save* | `AppointmentService.BookAsync()` | `Repo<AppointmentSlot>.GetAsync()` + `Repo<Patient>.GetAsync()` + `SaveChangesAsync()` | `AppointmentSlots`Â table, `Patients`Â table | *Save* button disabled & spinner shown until promise resolves |

> **Usage**Â Â Extend this matrix for each new feature to visualise endâ€‘toâ€‘end calls.

---

## 3Â Â Quality Gates & PR Template (excerpt)

* [ ] All layers modified if needed (Domain â†’ Business â†’ Infra â†’ UI).
* [ ] AppDbContext change covered by migration & test.
* [ ] New/changed public APIs have XMLâ€‘docs.
* [ ] Unit + integration tests added, passing.
* [ ] `dotnet format` produces no diffs.
* [ ] Performance budget not exceeded (Telemetry OK).
* [ ] Security checklist (input validation, authz) ticked.

Attach:

1. **ERD diff** (dbdiagram.io PNG) if schema changed.
2. **Screenshot/GIF** for UI tweaks.

---

## 4Â Â Tips, Traps, & Patterns

| âœ…Â Do                                                  | ğŸš«Â Donâ€™t                                                      |
| ----------------------------------------------------- | ------------------------------------------------------------- |
| Use **FeatureÂ Flags** for risky flows.                | Merge partiallyâ€‘implemented code behind `/* TODO */`.         |
| Start with **failing tests** (TDD).                   | Skip tests â€œuntil QAâ€.                                        |
| Reâ€‘use **Specification pattern** for complex filters. | Leak `IQueryable` to Business/UI.                             |
| Keep **methods â‰¤Â 20Â LOC**.                            | Put multiâ€‘entity transactions across different UoW instances. |

---

### Glossary

* **Vertical slice**Â â€“ Minimal path slicing through UI â†’ Business â†’ Infra â†’ DB.
* **Feature Flag**Â â€“ Configuration toggle (launchDarkly/appSettings) to enable logic without redeploy.
* **Specification**Â â€“ Encapsulated LINQ predicate & includes used by Repository.

---

> **Remember**Â â€”Â Every slice is done only when **all** tests pass, code is reviewed, migrations are applied, and documentation is updated. Repeat until the feature backlog is empty!
